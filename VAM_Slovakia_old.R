
## Clear environment, if needed
rm(list = ls())
setwd("/Users/irmasirutyte/Desktop/VAM Slovakia")

## Libraries
library(robotoolbox) # This loads koboloadeR package
library(haven)
library(tidyverse)
library(readxl)
library(srvyr)
library(ggplot2)
library(robotoolbox)
library(labelled)
library(remotes)
library(dm)
library(janitor)
library(dplyr)
library(DiagrammeR)
library(Hmisc)
library(xlsx)
library(writexl)
library(expss)
library(unhcrthemes)
library(ggplot2)
library(openxlsx)



sheet_names = excel_sheets("Data/Slovakia_MSNA_2023_-_all_versions_-_False_-_2023-09-05-12-41-24_vyčistěno3.xlsx") # get sheet names
sheet_names # print sheet names

# Read Sheet 1
df_hh <- read_excel("Data/Slovakia_MSNA_2023_-_all_versions_-_False_-_2023-09-05-12-41-24_vyčistěno3.xlsx", sheet = "Slovakia_MSNA_2023")
View(df_hh)


df_hh <- df_hh %>%
  rename("index" = "_index")

# Read Sheet 2
df_ind <- read_excel("Data/Slovakia_MSNA_2023_-_all_versions_-_False_-_2023-09-05-12-41-24_vyčistěno3.xlsx", sheet = "Info")

df_ind <- df_ind %>%
  rename("parent_index" = "_parent_index")

# ------------------------------------------------------------------------------
# DISABILITY
# ------------------------------------------------------------------------------
# WG.1.1_SS_DIFF_SEE
# WG.1.2_SS_DIFF_HEAR
# WG.1.3_SS_DIFF_WALK
# WG.1.4_SS_DIFF_REM
# WG.1.5_SS_DIFF_DRESS
# WG.1.6_SS_DIFF_COMM

df_ind <-  df_ind %>%
  mutate( # disability identifier variables according to Washington Group standards
    disaux1_34 = WG.1.1_SS_DIFF_SEE %in% c("lot_difficulty","cannot_all"), # indicator variables for all 6 domains with value TRUE if A LOT OF DIFFICULTY or CANNOT DO AT ALL
    disaux2_34 = WG.1.2_SS_DIFF_HEAR %in% c("lot_difficulty","cannot_all"),
    disaux3_34 = WG.1.3_SS_DIFF_WALK %in% c("lot_difficulty","cannot_all"),
    disaux4_34 = WG.1.4_SS_DIFF_REM %in% c("lot_difficulty","cannot_all"),
    disaux5_34 = WG.1.5_SS_DIFF_DRESS %in% c("lot_difficulty","cannot_all"),
    disaux6_34 = WG.1.6_SS_DIFF_COMM %in% c("lot_difficulty","cannot_all")
  ) %>%
  mutate(
    disSum34 = rowSums(select(., disaux1_34, disaux2_34 , disaux3_34 , disaux4_34 , disaux5_34 , disaux6_34)) # count number of TRUE indicator variables over 6 domains
    
  ) %>%
  mutate(
    DISABILITY3 = case_when( # : the level of inclusion is at least one domain/question is coded A LOT OF DIFFICULTY or CANNOT DO AT ALL.
      disSum34 >= 1 ~ 1,
      disSum34 == 0 & (!(WG.1.1_SS_DIFF_SEE %in% c("refused","DoNotKnow") & WG.1.2_SS_DIFF_HEAR %in% c("refused","DoNotKnow") & WG.1.3_SS_DIFF_WALK %in% c("refused","DoNotKnow") & WG.1.4_SS_DIFF_REM %in% c("refused","DoNotKnow") & WG.1.5_SS_DIFF_DRESS %in% c("refused","DoNotKnow") & WG.1.6_SS_DIFF_COMM %in% c("refused","DoNotKnow"))) ~ 0,
      WG.1.1_SS_DIFF_SEE %in% c("refused","DoNotKnow") & WG.1.2_SS_DIFF_HEAR %in% c("refused","DoNotKnow") & WG.1.3_SS_DIFF_WALK %in% c("refused","DoNotKnow") & WG.1.4_SS_DIFF_REM %in% c("refused","DoNotKnow") & WG.1.5_SS_DIFF_DRESS %in% c("refused","DoNotKnow") & WG.1.6_SS_DIFF_COMM %in% c("refused","DoNotKnow") ~ 98
    )
  ) %>%
  mutate(
    DISABILITY3 = labelled(DISABILITY3,
                           labels = c(
                             "Without disability" = 0,
                             "With disability" = 1,
                             "Unknown" = 98
                           ),
                           label = "Washington Group disability identifier 3"))

### Calculate having at least one disability identifier among 4 categories 

df_ind <- df_ind %>%
  mutate(disability = case_when(DISABILITY3 == 1 ~ 1, 
                                TRUE ~ 0)
  ) %>%
  mutate(disability = labelled(disability,
                               labels = c(
                                 "Without disability" = 0,
                                 "With disability" = 1)
  ))

table(df_ind$disability)

# -----------------------------------------------------------------------------
# FOOD CONSUMPTION SCORE
# -----------------------------------------------------------------------------

# FS.1.1_NUM_FOOD
# FS.1.2_NUM_PULSES
# FS.1.3_NUM_DAIRY
# FS.1.4_NUM_MEAT
# FS.1.5_NUM_VEG
# FS.1.6_NUM_FRUITS
# FS.1.7_NUM_OIL
# FS.1.8_NUM_SUGAR
# FS.1._NUM_SPICES

#assign variable and value labels
#variable labels
var_label(df_hh$FS.1.1_NUM_FOOD) <- "Cereals, grains, roots and tubers, such as:"
var_label(df_hh$FS.1.2_NUM_PULSES) <- "Pulses/ legumes / nuts, such as:"
var_label(df_hh$FS.1.3_NUM_DAIRY) <- "Milk and other dairy products, such as:"
var_label(df_hh$FS.1.4_NUM_MEAT) <- "Meat, fish and eggs, such as:"
var_label(df_hh$FS.1.5_NUM_VEG) <- "Vegetables and leaves, such as:"
var_label(df_hh$FS.1.6_NUM_FRUITS) <- "Fruits, such as:"
var_label(df_hh$FS.1.7_NUM_OIL) <- "Oil/fat/butter, such as:"
var_label(df_hh$FS.1.8_NUM_SUGAR) <- "Sugar, or sweet, such as:"
var_label(df_hh$FS.1._NUM_SPICES) <- "Condiments/Spices, such as:"

df_hh <- df_hh %>%
  mutate(across(c(FS.1.1_NUM_FOOD, FS.1.2_NUM_PULSES, FS.1.3_NUM_DAIRY,FS.1.4_NUM_MEAT, FS.1.5_NUM_VEG, FS.1.6_NUM_FRUITS, FS.1.7_NUM_OIL, FS.1.8_NUM_SUGAR,FS.1._NUM_SPICES), ~ replace(., . %in% c(9999, 8888), NA)))

# calculate FCS
df_hh <- df_hh %>% mutate(FCS = (2 * FS.1.1_NUM_FOOD) +(3 * FS.1.2_NUM_PULSES) +(4*FS.1.4_NUM_MEAT) +(4*FS.1.3_NUM_DAIRY) + FS.1.5_NUM_VEG  + FS.1.6_NUM_FRUITS +(0.5*FS.1.7_NUM_OIL) +(0.5*FS.1.8_NUM_SUGAR))
var_label(df_hh$FCS) <- "Food Consumption Score"

#create FCG groups based on 21/25 or 28/42 thresholds

#Use this when analyzing a country with low consumption of sugar and oil - thresholds 21-35
df_hh <- df_hh %>% mutate(FCSCat21 = case_when(
  FCS <= 21 ~ 1, between(FCS, 21.5, 35) ~ 2, FCS > 35 ~ 3))

val_lab(df_hh$FCSCat21) = num_lab("
             1 Poor
             2 Borderline
             3 Acceptable
")
var_label(df_hh$FCSCat21) <- "FCS Categories"

# Important note: pay attention to the threshold used by your CO when selecting the syntax (21 cat. vs 28 cat.)
# Use this when analyzing a country with high consumption of sugar and oil – thresholds 28-42

df_hh <- df_hh %>% mutate(FCSCat28 = case_when(
  FCS <= 28 ~ 1, 
  between(FCS, 28.5, 42) ~ 2, 
  FCS > 42 ~ 3))

val_lab(df_hh$FCSCat28) = num_lab("
             1 Poor
             2 Borderline
             3 Acceptable
")
var_label(df_hh$FCSCat28) <- "FCS Categories"


# ------------------------------------------------------------------------------
# LIVELIHOOD COPING STRATEGIES INDEX
# ------------------------------------------------------------------------------

# variable labels 
#stress
var_label(df_hh$L9_SS_MIGR) <- "Entire household migrated/displaced due to a lack of resources to cover basic needs"
var_label(df_hh$L1_SS_BASIC) <- "Spent savings to meet essential needs"
var_label(df_hh$L2_SS_ASSETS) <- "Sell household assets/goods (radio, furniture, television, jewellery etc.) to meet basic needs"
var_label(df_hh$L3_SS_FOOD_CREDIT) <- "Purchase food on credit or borrowed food due to a lack of resources to cover basic needs"

#crisis
var_label(df_hh$L4_SS_SELL_ASSETS) <- "Sell productive assets or means of transport (sewing machine, bicycle, car, etc.) due to a lack of resources to cover basic needs"
var_label(df_hh$L7_SS_OUT_SCH) <- "Withdrew school-aged children from school because of a lack of food or money to buy food"
var_label(df_hh$L5_SS_REDUCED_HLTH_EXP) <- "Reduce essential health expenditures (including drugs) due to a lack of resources to cover basic needs"
var_label(df_hh$L6_SS_REDUCED_EDU_EXP) <- "Reduce essential education expenditures due to a lack of resources to cover basic need"

#emergency
var_label(df_hh$L8_SS_SELL_HSE_LND) <- "Sell house or land (including inside Ukraine) to cover basic needs"
var_label(df_hh$L11_SS_DEGR_INCM) <- "Use degrading sources of income, illegal work, or high-risk jobs to cover basic needs"
var_label(df_hh$L10_SS_CHL_LAB) <- "Involve school-aged children in income generation to meet basic needs"

view(df_hh)

df_hh <- df_hh %>%
  mutate(across(c(L9_SS_MIGR, L1_SS_BASIC, L2_SS_ASSETS, L3_SS_FOOD_CREDIT, L4_SS_SELL_ASSETS, L7_SS_OUT_SCH, L5_SS_REDUCED_HLTH_EXP, L6_SS_REDUCED_EDU_EXP, L8_SS_SELL_HSE_LND, L11_SS_DEGR_INCM, L10_SS_CHL_LAB), ~
                  case_when(
                    . == "no_not_needed" ~ 10,
                    . == "no_already_done" ~ 20,
                    . == "yes" ~ 30,
                    . == "not_applicable" ~ 999,
                    . == "prefer_not_to_answer" ~ 999,
                    . == "dont_know" ~ 999,
                    TRUE ~ as.numeric(.)
                  )
  ))  


# Display columns
selected_columns <- df_hh %>%
  select(L9_SS_MIGR, L1_SS_BASIC, L2_SS_ASSETS, L3_SS_FOOD_CREDIT)

# Print the selected columns
print(selected_columns)

#create a variable to specify if the household used any of the strategies by severity

#stress
df_hh <- df_hh %>% mutate(stress_coping_EN = case_when(
  L9_SS_MIGR== 20 | L9_SS_MIGR== 30 ~ 1,
  L1_SS_BASIC == 20 | L1_SS_BASIC == 30 ~ 1,
  L2_SS_ASSETS == 20 | L2_SS_ASSETS == 30 ~1,
  L3_SS_FOOD_CREDIT == 20 | L3_SS_FOOD_CREDIT == 30 ~ 1,
  TRUE ~ 0))
var_label(df_hh$stress_coping_EN) <- "Did the HH engage in stress coping strategies"

#Crisis
df_hh <- df_hh %>% mutate(crisis_coping_EN = case_when(
  L4_SS_SELL_ASSETS == 20 |  L4_SS_SELL_ASSETS == 30 ~ 1,
  L7_SS_OUT_SCH == 20 | L7_SS_OUT_SCH == 30 ~ 1,
  L5_SS_REDUCED_HLTH_EXP == 20 | L5_SS_REDUCED_HLTH_EXP == 30 ~ 1,
  L6_SS_REDUCED_EDU_EXP == 20 | L6_SS_REDUCED_EDU_EXP == 30 ~ 1,
  TRUE ~ 0))
var_label(df_hh$crisis_coping_EN) <- "Did the HH engage in crisis coping strategies"

#Emergency
df_hh <- df_hh %>% mutate(emergency_coping_EN = case_when(
  L8_SS_SELL_HSE_LND == 20 |  L8_SS_SELL_HSE_LND == 30 ~ 1,
  L11_SS_DEGR_INCM == 20 | L11_SS_DEGR_INCM == 30 ~ 1,
  L10_SS_CHL_LAB == 20 | L10_SS_CHL_LAB == 30 ~ 1,
  TRUE ~ 0))
var_label(df_hh$emergency_coping_EN) <- "Did the HH engage in emergency coping strategies"


#calculate Max_coping_behaviour
df_hh <- df_hh %>% mutate(Max_coping_behaviourEN = case_when(
  emergency_coping_EN == 1 ~ 4,
  crisis_coping_EN == 1 ~ 3,
  stress_coping_EN == 1 ~ 2,
  TRUE ~ 1))
var_label(df_hh$Max_coping_behaviourEN) <- "Summary of asset depletion"
val_lab(df_hh$Max_coping_behaviourEN) = num_lab("
             1 HH not adopting coping strategies
             2 Stress coping strategies
             3 Crisis coping strategies
             4 Emergencies coping strategies
")

# -----------------------------------------------------------------------------
# REDUCED COPING STRATEGIES INDEX
# -----------------------------------------------------------------------------

# FS.3.1_NUM_COPE - less preferred food
# FS.3.2_NUM_BURROW - borrow
# FS.3.3_NUM_LIM - limit portion size
# FS.3.4_NUM_LACK - restrict consumption by adults in order for small children to eat
# FS.3.5_NUM_REDUCED - reduce number of meals eaten

# assign variable and value labels
var_label(df_hh$FS.3.1_NUM_COPE) <-  "Rely on less preferred and less expensive food in the past 7 days"
var_label(df_hh$FS.3.2_NUM_BURROW) <- "Borrow food or rely on help from a relative or friend in the past 7 days"
var_label(df_hh$FS.3.5_NUM_REDUCED) <-  "Reduce number of meals eaten in a day in the past 7 days"
var_label(df_hh$FS.3.3_NUM_LIM) <- "Limit portion size of meals at meal times in the past 7 days"
var_label(df_hh$FS.3.4_NUM_LACK) <-  "Restrict consumption by adults in order for small children to eat in the past 7 days"

# Replace multiple specific numeric values (e.g., 999 and 888) with NA in multiple columns
df_hh <- df_hh %>%
  mutate(across(c(FS.3.1_NUM_COPE, FS.3.2_NUM_BURROW, FS.3.5_NUM_REDUCED,FS.3.3_NUM_LIM, FS.3.4_NUM_LACK), ~ replace(., . %in% c(9999, 8888), NA)))


# Display columns 
selected_columns <- df_hh %>%
  select(FS.3.1_NUM_COPE, FS.3.2_NUM_BURROW, FS.3.5_NUM_REDUCED, FS.3.3_NUM_LIM,FS.3.4_NUM_LACK)

# Print the selected columns
print(selected_columns)


# calculate reduced Coping Strategy Index (rCSI)
df_hh <- df_hh %>% mutate(rCSI = FS.3.1_NUM_COPE + (2 * FS.3.2_NUM_BURROW) + FS.3.5_NUM_REDUCED + FS.3.3_NUM_LIM + (3 * FS.3.4_NUM_LACK))
var_label(df_hh$rCSI) <- "Reduced coping strategies index (rCSI)"

# Unweighted
rCSI_table_mean <- df_hh %>% 
  drop_na(rCSI) %>% 
  summarise(meanrCSI = mean(rCSI))


# ------------------------------------------------------------------------------
# EXPENDITURE
# ------------------------------------------------------------------------------

# SE.2.1_NUM_FOOD - monthly
# SE.2.2_NUM_ACCOM - monthly
# SE.2.4_NUM_HYG - monthly
# SE.2.5_NUM_COMM - monthly
# SE.2.6_NUM_HH_BILL - monthly
# SE.2.3_NUM_HLTH - monthly
# SE.2.8_NUM_HLTH_6_MTH  -  6 months 
# SE.2.10_NUM_EDU - 12 months 
# SE.2.9_NUM_DEBT - 6 months
# SE.2.7_NUM_OTH - monthly
# 9 categories in total

# Specify the list of variables
variables_to_replace <- c(
  "SE.2.1_NUM_FOOD",
  "SE.2.2_NUM_ACCOM",
  "SE.2.4_NUM_HYG",
  "SE.2.5_NUM_COMM",
  "SE.2.6_NUM_HH_BILL",
  "SE.2.3_NUM_HLTH",
  "SE.2.8_NUM_HLTH_6_MTH",
  "SE.2.10_NUM_EDU",
  "SE.2.9_NUM_DEBT",
  "SE.2.7_NUM_OTH"
)

# Loop through the variables and replace 9999 or 99999 with NA
for (var in variables_to_replace) {
  df_hh[[var]] <- ifelse(df_hh[[var]] %in% c(9999, 99999,8888), NA, df_hh[[var]])
}

#---------------------------------------------------------------
# Economic Capacity to Meet Essential Needs (ECMEN) ------------
# ---------------------------------------------------------------
# WFP-VAM/Resources https://resources.vam.wfp.org/data-analysis/quantitative/essential-needs/economic-capacity-to-meet-essential-needs-ecmen
# Calculation: 1. Identify the relevant MEB: From Yigit in Romania CO --> Threshold of absolute poverty	2285.2; Threshold of extreme poverty	1843.0
#              2. Aggregate consumption expenditures to establish household economic capacity
#              3. Compare the economic capacity of each household against the MEB to establish whether a household is above this threshold, i.e. whether it can meet its essential needs.
#              4. Produce the ECMEN indicator by calculating the percentage of households whose economic capacity falls above the MEB threshold. 

# Note 1: In the version used for assessment: a) the household economic capacity aggregate should not include the value of consumed in-kind assistance gifts; b) the value of the cash assistance received from the humanitarian sector should be deducted from the household economic capacity aggregate (but only for the estimated share of the cash assistance that is used for consumption, when available).

# HEALTHCARE EXPENDITURE 6 MONTHS - CONVERT TO 1 MONTH

# df_hh$SE.2.8_NUM_HLTH_6_MTH  <- as.numeric(df_hh$SE.2.0_NUM_HH_EXP)
df_hh$SE.2.8_NUM_HLTH_1_MTH  <- round(df_hh$SE.2.8_NUM_HLTH_6_MTH  / 6, 2)

# DEBT EXPENDITURE 6 MONTHS - CONVERT TO 1 MONTH
df_hh$SE.2.9_NUM_DEBT_1_MTH  <- round(df_hh$SE.2.9_NUM_DEBT  / 6, 2)

# EDUCATION EXPENDITURE 12 MONTHS - CONVERT TO 1 MONTH
df_hh$SE.2.10_NUM_EDU_1_MTH  <- round(df_hh$SE.2.10_NUM_EDU  / 12, 2)

df_hh$health_expenditure = round(df_hh$SE.2.3_NUM_HLTH + df_hh$SE.2.8_NUM_HLTH_1_MTH,2)

# Drop these columns:  
df_hh <- df_hh[, !(names(df_hh) %in% c("SE.2.8_NUM_HLTH_1_MTH", "SE.2.3_NUM_HLTH"))]


df_hh <- df_hh %>%
  rename(
    HHExp_FoodItems_1M = SE.2.1_NUM_FOOD,
    HHExpNFRent_1M = SE.2.2_NUM_ACCOM,
    HHExpNFHyg_1M = SE.2.4_NUM_HYG,
    HHExpNFUtil_1M = SE.2.6_NUM_HH_BILL,
    HHExpNFPhone_1M = SE.2.5_NUM_COMM,
    HHExpNFMedServ_1M = health_expenditure,
    HHExpNFEdu_1M = SE.2.10_NUM_EDU_1_MTH,
    HHExpNFDebt_1M = SE.2.9_NUM_DEBT_1_MTH, # new
    HHExpNFOther_1M = SE.2.7_NUM_OTH

) %>%
  mutate(
    HHExp_FoodItems_1M_median = ifelse(is.na(HHExp_FoodItems_1M), median(HHExp_FoodItems_1M, na.rm = TRUE), HHExp_FoodItems_1M),
    HHExpNFRent_1M_median = ifelse(is.na(HHExpNFRent_1M), median(HHExpNFRent_1M, na.rm = TRUE), HHExpNFRent_1M),
    HHExpNFHyg_1M_median = ifelse(is.na(HHExpNFHyg_1M), median(HHExpNFHyg_1M, na.rm = TRUE), HHExpNFHyg_1M),
    HHExpNFUtil_1M_median = ifelse(is.na(HHExpNFUtil_1M), median(HHExpNFUtil_1M, na.rm = TRUE), HHExpNFUtil_1M),
    HHExpNFPhone_1M_median = ifelse(is.na(HHExpNFPhone_1M), median(HHExpNFPhone_1M, na.rm = TRUE), HHExpNFPhone_1M),
    HHExpNFMedServ_1M_median = ifelse(is.na(HHExpNFMedServ_1M), median(HHExpNFMedServ_1M, na.rm = TRUE), HHExpNFMedServ_1M),
    HHExpNFEdu_1M_median = ifelse(is.na(HHExpNFEdu_1M), median(HHExpNFEdu_1M, na.rm = TRUE), HHExpNFEdu_1M),
    HHExpNFDebt_1M_median = ifelse(is.na(HHExpNFDebt_1M), median(HHExpNFDebt_1M, na.rm = TRUE), HHExpNFDebt_1M),
    HHExpNFOther_1M_median = ifelse(is.na(HHExpNFOther_1M), median(HHExpNFOther_1M, na.rm = TRUE), HHExpNFOther_1M)
  )


# Add labels to the renamed columns
label(df_hh$HHExp_FoodItems_1M) <- "Expenditures on Food Items (1-Month)"
label(df_hh$HHExpNFRent_1M) <- "Expenditures on rent (1-Month)"
label(df_hh$HHExpNFHyg_1M) <- "Expenditures on non-food household items for regular purchase (hygiene, etc.) (1-Month)"
label(df_hh$HHExpNFUtil_1M) <- "Expenditures on utilities (electricity or gas connection, etc.) (1-Month)"
label(df_hh$HHExpNFPhone_1M) <- "Expenditures on communication (1-Month)"
label(df_hh$HHExpNFEdu_1M) <- "Expenditures on education costs (1-Month)"
label(df_hh$HHExpNFMedServ_1M) <- "Expenditures on health-related costs (1-Month)"
label(df_hh$HHExpNFDebt_1M) <- "Expenditures on debt (1-month)"
label(df_hh$HHExpNFOther_1M) <- "Expenditure on all other frequent expenditures (1-Month)"


# 3. Calculate household economic capacity
# Note: Remember that for the version of ECMEN used for assessments (excluding assistance), the value of consumed in-kind assistance and gifts should be excluded from the household economic capacity aggregate
# In our case we do not have information regarding the assistance used for consumption
# Also, no information on consumption of food from own-production 

# Select the columns you want to sum
columns_to_sum_median <- c(
  "HHExp_FoodItems_1M_median", "HHExpNFRent_1M_median", "HHExpNFHyg_1M_median",
  "HHExpNFUtil_1M_median", "HHExpNFPhone_1M_median",  "HHExpNFMedServ_1M_median",
  "HHExpNFEdu_1M_median", "HHExpNFDebt_1M_median", "HHExpNFOther_1M_median"
)

# Use rowSums to sum the selected columns while ignoring missing values
df_hh$HHExpenditure_median <- round(rowSums(df_hh[columns_to_sum_median], na.rm = TRUE), 2)


# Select the columns you want to sum
columns_to_sum <- c(
  "HHExp_FoodItems_1M", "HHExpNFRent_1M", "HHExpNFHyg_1M",
  "HHExpNFUtil_1M", "HHExpNFPhone_1M",  "HHExpNFMedServ_1M",
  "HHExpNFEdu_1M", "HHExpNFDebt_1M", "HHExpNFOther_1M"
)

# Use rowSums to sum the selected columns while ignoring missing values
df_hh$HHExpenditure <- round(rowSums(df_hh[columns_to_sum], na.rm = TRUE), 2)


# Calculate the average
average1 <- mean(df_hh$HHExpenditure, na.rm = TRUE)
average_median <- mean(df_hh$HHExpenditure_median)

# Print the average
cat("The average is:", average1) # equals 283.86
cat("The average imputing median is:", average_median) # equals 282.87 (slightly lower since median is at 250)



# Add a label to the newly created col
# Add a label to the newly created column (optional)

label(df_hh$HHExpenditure) <- "Household Economic Capacity - monthly"
label(df_hh$HHExpenditure_median) <- "Household Economic Capacity (median)"


### ----------------------------------------------------------------------------
### EXPENDITURE PER CAPITA
### ----------------------------------------------------------------------------

# 5.1 Compute household size
df_hh$HHSize <- df_hh$DR8_NUM_HH_SIZE

# 5.2 Calculate household economic capacity per capita
df_hh$PCExpenditure <- df_hh$HHExpenditure / df_hh$HHSize

# Calculate the mean (average) of PCExpenditure
average_PCExpenditure <- mean(df_hh$PCExpenditure, na.rm = TRUE)

# Calculate the median of PCExpenditure
median_PCExpenditure <- median(df_hh$PCExpenditure, na.rm = TRUE)

# Print the results
cat("Average PCExpenditure:", average_PCExpenditure, "\n")
cat("Median PCExpenditure:", median_PCExpenditure, "\n")


# Add variable label
attr(df_hh$PCExpenditure, "label") <- "Household Economic Capacity per capita - monthly"  

### ------------------------------------------------------------------------------
### CALCULATE VARIABLES ON HOUSEHOLD LEVEL
### ------------------------------------------------------------------------------

df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(
    number_adults_above_14 = sum(DR.11_NUM_AGE >= 14),
    number_children_below_14 = sum(DR.11_NUM_AGE < 14),
    number_order_persons_above_65 = sum(DR.11_NUM_AGE >= 65),
  ) %>%
  ungroup()


df_ind_meb <- df_ind %>%
  select("parent_index", "number_adults_above_14","number_children_below_14","number_order_persons_above_65") 

# Create a temporary dataset with unique parent_index rows from df_ind_meb
unique_df_ind_meb <- df_ind_meb %>%
  distinct(parent_index, .keep_all = TRUE)


df_hh <- df_hh %>%
  left_join(unique_df_ind_meb, by = c("index" = "parent_index"))

df_hh$family_meb = (268.88 * 1.0) + (268.88 * 0.5 * (df_hh$number_adults_above_14 - 1)) + (268.88 * 0.3 * df_hh$number_children_below_14)

# Create a new variable indicating economic capacity relative to MEB/SMEB
df_hh$HHExp_ECMEN <- ifelse(df_hh$HHExpenditure > df_hh$family_meb, 1,
                            ifelse(df_hh$HHExpenditure <= df_hh$family_meb, 2,
                                   NA))


################################################################################

df_hh$family_smeb = df_hh$family_meb * 0.8

# Create a new variable indicating economic capacity relative to MEB/SMEB
df_hh$HHExp_ECMEN_2 <- ifelse(df_hh$HHExpenditure > df_hh$family_meb, 1,
                            ifelse(df_hh$HHExpenditure > df_hh$family_smeb & df_hh$HHExpenditure <= df_hh$family_meb, 2,
                                   ifelse(df_hh$HHExpenditure <= df_hh$family_smeb & !is.na(df_hh$HHExpenditure), 3, NA)))



# ------------------------------------------------------------------------------
# COMBINE VARIABLES
# Proportion of PoC with access to health services
# ------------------------------------------------------------------------------

# Combine categories 1 and 2 in NCS to create 3 categories
df_hh$NCS_3cat <- NA  # Create a new variable

df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN %in% c(1, 2)] <- 1  # No coping/stressed
df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN == 3] <- 2  # Crisis
df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN == 4] <- 3  # Emergency

# Add value labels
levels(df_hh$NCS_3cat) <- c("No coping/stressed", "Crisis", "Emergency")

# Add variable label
attr(df_hh$NCS_3cat, "label") <- "NCS 3 categories"


#-----------------------------------------------
# 1. Combined FCS, LCSI & ECMEN --------------
#-----------------------------------------------

################################################################################
###   SCENARIO 1
################################################################################

# NCS_3CAT - Livelihood coping strategies
# 1  -  No coping/stressed
# 2  -  Crisis
# 3  -  Emergency

# FCSCat28- Food consumption score
# 1 - Poor
# 2 - Borderline
# 3 - Acceptable

# ECMEN - Economic capacity to meet basic needs
# 1 - Above MEB (minimum expenditure basket)
# 2 - Between MEB & SMEB (between minimum expenditure basket, and survival minimum expenditure basket)


# Create a new variable Vulnerability_3var_4cat
df_hh$Vulnerability_fcs_ncs_ecmen_4cat <- NA

# Define conditions and assign values
df_hh$Vulnerability_fcs_ncs_ecmen_4cat[(
  (df_hh$HHExp_ECMEN == 2 & df_hh$NCS_3cat == 3 & df_hh$FCSCat28 %in% c(1, 2, 3)) | # below MEB and use Emergency coping strategies 
    (df_hh$HHExp_ECMEN == 2 & df_hh$NCS_3cat %in% c(1, 2, 3) & df_hh$FCSCat28 == 1) | # below MEB and FCS Poor
    (df_hh$HHExp_ECMEN %in% c(1, 2) & df_hh$NCS_3cat == 3 & df_hh$FCSCat28 == 1) # applying Emergency strategies and FCS Poor
)] <- 1  # Extremely vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat[(
  (df_hh$HHExp_ECMEN %in% c(2) & df_hh$NCS_3cat %in% c(1,2) & df_hh$FCSCat28 %in% c(2,3)) | # below MEB and No coping strategies / Stress or Crisis and FCS Poor or Acceptable
  (df_hh$HHExp_ECMEN %in% c(1) & df_hh$NCS_3cat %in% c(3) & df_hh$FCSCat28 %in% c(2,3)) | # above MEB and using Emergency and FCS Acceptable or Borderline
  (df_hh$HHExp_ECMEN %in% c(1) & df_hh$NCS_3cat %in% c(1,2) & df_hh$FCSCat28 %in% c(1))  # above MEB and using No coping strategies / Stress or Crisis and FCS Poor
)] <- 2  # Highly vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat[(
  (df_hh$HHExp_ECMEN == 1 & df_hh$NCS_3cat %in% c(1,2) & df_hh$FCSCat28 %in% c(2,3)) # above MEB qnd Stress / No coping and FCS Acceptable
)] <- 3  # Moderately vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat[(
  df_hh$HHExp_ECMEN == 1 & df_hh$NCS_3cat == 1 & df_hh$FCSCat28 == 3 # Above MEB and Stress / No coping and FCS Acceptable
)] <- 4  # Not vulnerable


table(df_hh$Vulnerability_fcs_ncs_ecmen_4cat)


# Define conditions and assign values for a dependent variable (should be 1 or 0, the 2 will be removed later on)
df_hh <- df_hh %>% mutate(vulnerability_log = case_when(
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat == 1 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat == 2 ~ 1 , # Extremely or highly vulnerable
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat == 3 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat == 4 ~ 0, # Moderately vulnerable or not vulnerable
  TRUE ~ 2))


table(df_hh$vulnerability_log)


# Add variable label
attr(df_hh$Vulnerability_fcs_ncs_ecmen_4cat, "label") <- "Vulnerability Tier Classification (FCS, NCS & ECMEN)"

# Define value labels
value_labels_2 <- c("Extremely vulnerable", "Highly vulnerable","Moderately vulnerable", "Not vulnerable")

# Apply value labels
df_hh$Vulnerability_fcs_ncs_ecmen_4cat <- factor(df_hh$Vulnerability_fcs_ncs_ecmen_4cat, levels = 1:4, labels = value_labels_2)


################################################################################
###   SCENARIO 2
################################################################################

# NCS_3CAT - Livelihood coping strategies
# 1  -  No coping/stressed
# 2  -  Crisis
# 3  -  Emergency

# FCSCat28- Food consumption score
# 1 - Poor
# 2 - Borderline
# 3 - Acceptable

# ECMEN - Economic capacity to meet basic needs
# 1 - Above MEB (minimum expenditure basket)
# 2 - Between MEB & SMEB (between minimum expenditure basket, and survival minimum expenditure basket)
# 3 - Below SMEB (survival minimum expenditure basket)

# SAME AS PREVIOUS APPROACH - ONLY USE 80% OF MEB AS SMEB (SAME SHARE AS IN MOLDOVA)

# Define conditions and assign values
df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == 3 & df_hh$NCS_3cat == 3 & df_hh$FCSCat28 %in% c(1, 2, 3)) |
    (df_hh$HHExp_ECMEN_2 == 3 & df_hh$NCS_3cat %in% c(1, 2, 3) & df_hh$FCSCat28 == 1) |
    (df_hh$HHExp_ECMEN_2 %in% c(1, 2, 3) & df_hh$NCS_3cat == 3 & df_hh$FCSCat28 == 1)
)] <- 1  # Extremely vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == 3 & df_hh$NCS_3cat %in% c(1, 2) & df_hh$FCSCat28 %in% c(3, 2)) |
    (df_hh$HHExp_ECMEN_2 %in% c(1, 2) & df_hh$NCS_3cat == 3 & df_hh$FCSCat28 %in% c(3, 2)) |
    (df_hh$HHExp_ECMEN_2 %in% c(1, 2) & df_hh$NCS_3cat %in% c(1, 2) & df_hh$FCSCat28 == 1)
)] <- 2  # Highly vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == 2 & df_hh$NCS_3cat %in% c(1, 2) & df_hh$FCSCat28 %in% c(3, 2)) |
    (df_hh$HHExp_ECMEN_2 %in% c(1, 2) & df_hh$NCS_3cat == 2 & df_hh$FCSCat28 %in% c(3, 2)) |
    (df_hh$HHExp_ECMEN_2 %in% c(1, 2) & df_hh$NCS_3cat %in% c(1, 2) & df_hh$FCSCat28 == 2)
)] <- 3  # Moderately vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  df_hh$HHExp_ECMEN_2 == 1 & df_hh$NCS_3cat == 1 & df_hh$FCSCat28 == 3
)] <- 4  # Not vulnerable

table(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2)


# Define conditions and assign values for a dependent variable (should be 1 or 0, the 2 will be removed later on)
df_hh <- df_hh %>% mutate(vulnerability_log_2 = case_when(
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 1 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 2 ~ 1 , # Extremely or highly vulnerable
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 3 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 4 ~ 0, # Moderately vulnerable or not vulnerable
  TRUE ~ 2))


table(df_hh$vulnerability_log_2)


# Add variable label
attr(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2, "label") <- "Vulnerability Tier Classification (FCS, NCS & ECMEN)"

# Define value labels
value_labels_2 <- c("Extremely vulnerable", "Highly vulnerable","Moderately vulnerable", "Not vulnerable")

# Apply value labels
df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 <- factor(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2, levels = 1:4, labels = value_labels_2)


################################################################################ 

# Add variable label
attr(df_hh$HHExp_ECMEN, "label") <- "ECMEN Scenario 1"

# Define value labels
value_labels_MEB <- c("1 - Above MEB", 
                      "2 - Below MEB")

# Apply value labels
df_hh$HHExp_ECMEN <- factor(df_hh$HHExp_ECMEN, levels = 1:2, labels = value_labels_MEB)

# Display table
table(df_hh$HHExp_ECMEN)


# Add variable label
attr(df_hh$HHExp_ECMEN_2, "label") <- "ECMEN Scenario 2"

# Define value labels
value_labels <- c("1 - Above MEB", 
                  "2 - Between MEB & SMEB", 
                  "3 - Below SMEB")

# Apply value labels
df_hh$HHExp_ECMEN_2 <- factor(df_hh$HHExp_ECMEN_2, levels = 1:3, labels = value_labels)

# Display table
table(df_hh$HHExp_ECMEN_2)



# import other indicators calculated for MSNA
df_hh_slovakia_msna <- read_excel("/Users/irmasirutyte/Desktop/MSNA Composite/MSNA_updated_Slovakia/Combined/household_combined_indicators_slovakia.xlsx", sheet = "Sheet1")
df_ind_slovakia_msna <- read_excel("/Users/irmasirutyte/Desktop/MSNA Composite/MSNA_updated_Slovakia/Combined/individual_combined_indicators_slovakia.xlsx", sheet = "Sheet1")

# Rename _index to index in df_hh_slovakia_msna
df_hh_slovakia_msna <- df_hh_slovakia_msna %>% rename(index = "_index")

# List all column names of df_hh
column_names <- names(df_hh_slovakia_msna)
# Print the column names
print(column_names)

# Select the columns you want to keep in df_hh
df_hh_slovakia_msna <- df_hh_slovakia_msna %>%
  select( -resp_age_cat, -FCSCat21, -FCS, -stress_coping_EN, -crisis_coping_EN, -emergency_coping_EN, -rCSI, -Max_coping_behaviourEN,-DR7.2_SS_RESP_GEN,-DR7.3_NUM_RESP_AGE )  # Specify the variables to remove


# Merge the datasets 
df_hh <- left_join(df_hh, df_hh_slovakia_msna, by = "index")


################################################################################
#### - CALCULATE INCOME
################################################################################

# Select all income-related columns
columns_all_income <- c(
  "SE2.11a_NUM_INC_AMT_RGL", "SE2.11a_NUM_INC_AMT_CAS", "SE2.11a_NUM_INC_AMT_SLF", "SE2.11a_NUM_INC_AMT_OTH",
  "SE2.11b_NUM_BEN_AMT_CSH", "SE2.11b_NUM_BEN_AMT_DSB", "SE2.11b_NUM_BEN_AMT_UNE", "SE2.11b_NUM_BEN_AMT_CFG", "SE2.11b_NUM_BEN_AMT_OTH",
  "SE2.11d_NUM_BEN_OTH_CSH", "SE2.11d_NUM_BEN_OTH_INV", "SE2.11d_NUM_BEN_OTH_LON", "SE2.11d_NUM_BEN_OTH_REL_UKR","SE2.11d_NUM_BEN_OTH_REL_OUT_UKR","SE2.11d_NUM_BEN_OTH_OTH"	
)


# Loop through the variables and replace 9999 or 99999 with NA
for (var in columns_all_income) {
  df_hh[[var]] <- ifelse(df_hh[[var]] %in% c(9999, 99999,8888), NA, df_hh[[var]])
}

# Use rowSums to sum all the selected columns while ignoring missing values
df_hh$total_income_sum <- round(rowSums(df_hh[, columns_all_income], na.rm = TRUE), 2)

# Calculate the average
average_total_income <- mean(df_hh$total_income_sum, na.rm = TRUE)

# Print the average
print(average_total_income)

# Calculate the Pearson correlation coefficient
correlation_coefficient <- cor(df_hh$total_income_sum, df_hh$HHExpenditure)
# Print the result
cat("Pearson correlation coefficient:", correlation_coefficient, "\n")


################################################################################
# ------------------------------------------------------------------------------
#  REGRESSION MODELLING - Model 1 Vulnerability outcome 
# ------------------------------------------------------------------------------
################################################################################

# VARIABLE LIST
# Respondent characteristics:
# respondent age - 	DR7.3_NUM_RESP_AGE
# respondent gender - DR7.2_SS_RESP_GEN

# HOUSEHOLD LEVEL:
# hh size - DR8_NUM_HH_SIZE
# number pregnant - DR10_NUM_PREG_BF
# accommodation type -	SHL01_SS_ACCOM_TYP
# accommodation arrangement - SHL01.1_SS_ACCOM_ARR

# INDIVIDUAL LEVEL:
# elderly in the household - "elderly_hh"
# disabled in the household - "disability_hh"
# chronically ill / serious medical condition in the household - "chronic_illness"

# income_type -
# vulnerable / specific needs - 
# "single_parent"
# "marginalized" - is this available?

# random - 
# feeling safe walking in the neighborhood - PRT06_SS_SAFETY_LVL
# SC3_SS_EXP_HOSTILE - hostile behaviors from locals 

# income sources - check additional income sources 
names(df_hh)[names(df_hh) == "DR8_NUM_HH_SIZE"] <- "hh_size" # INCLUDE

table(df_hh$hh_size)


names(df_hh)[names(df_hh) == "DR10_NUM_PREG_BF"] <- "dummy_pregnant_breastfeeding" # INCLUDE

table(df_hh$dummy_pregnant_breastfeeding)

# dummy child not attending school
df_hh <- df_hh %>%
  mutate(dummy_pregnant_breastfeeding = case_when(
    df_hh$dummy_pregnant_breastfeeding > 0 ~ 1, 
    TRUE ~ 0
  ))


# dummy older persons
df_hh <- df_hh %>%
  mutate(dummy_older_persons = case_when(
    df_hh$number_order_persons_above_65 > 0 ~ 1, 
    TRUE ~ 0
  ))




################################################################################
###          ACCOMMODATION TYPE AND LIVING CONDITIONS
################################################################################


# Recode living conditions

names(df_hh)[names(df_hh) == "SHL07_SM_LIV_COND"] <- "living_conditions_issues" 
df_hh <- df_hh %>%
  mutate(living_conditions_issues = case_when(
    living_conditions_issues == "no_issues" ~ 0,
    TRUE ~ 1  # else assign that it has issues
  ))

table(df_hh$living_conditions_issues) # INLCUDE - 133 RESPONDENTS REPORTED HAVING SOME ISSUES (SAMPLE LOW BUT POSSIBLE TO INCLUDE)


names(df_hh)[names(df_hh) == "SHL08.1_SS_HEATING"] <- "house_heating"
table(df_hh$house_heating) # EXCLUDE - most people answered yes, only 15 respondents said NO

names(df_hh)[names(df_hh) == "PRT06_SS_SAFETY_LVL"] <-  "safety_neighbourhood"
table(df_hh$safety_neighbourhood) # EXCLUDE - (INSTEAD INCLUDE RMS INDICATOR)

names(df_hh)[names(df_hh) == "L12_SS_HV_BNK_ACC"] <- "owns_bank_account" 
table(df_hh$owns_bank_account) # EXCLUDE
table(df_hh$outcome13_1_bank_account) # INCLUDE BECAUSE IT'S BETTER TO HAVE 2 GROUPS FOR REGRESSION


names(df_hh)[names(df_hh) == "SHL01_SS_ACCOM_TYP"] <- "accommodation_type"
df_hh <- df_hh %>%
  mutate(accommodation_type = case_when(
    accommodation_type == "prefer_not_to_answer" ~ "other",
    accommodation_type == "hotel_hostel" ~ "other",
    TRUE ~ as.character(accommodation_type)  # Keep other values unchanged
  ))

table(df_hh$accommodation_type)


names(df_hh)[names(df_hh) == "SHL01.1_SS_ACCOM_ARR"] <- "accommodation_arrangement"

df_hh <- df_hh %>%
  mutate(accommodation_arrangement = case_when(
    accommodation_arrangement == "do_not_know" ~ "other",
    accommodation_arrangement == "prefer_not_to_answer" ~ "other",
    accommodation_arrangement == "full_payment_by_household" ~ "full_payment_by_household",
    accommodation_arrangement == "no_payment_free_government" ~ "no_payment_free",
    accommodation_arrangement == "no_payment_free_hosted" ~ "no_payment_free",
    accommodation_arrangement == "partial_payment_by_household" ~ "partial_payment_by_household",
    accommodation_arrangement == "partial_payment_hosted" ~ "partial_payment_by_household",
    accommodation_arrangement == "subsidized_by_employer" ~ "partial_payment_by_household",
    TRUE ~ as.character(accommodation_arrangement)  # Keep other values unchanged
  ))

table(df_hh$accommodation_arrangement)

# Recode "DoNotKnow" to "PreferNotAnswer" as NO to create dummy variation

names(df_hh)[names(df_hh) == "SHL01.2_SS_URB_RURAL"] <- "rural_urban"  # INCLUDE


df_hh <- df_hh %>%
  mutate(rural_urban = case_when(
    rural_urban == "do_not_know" ~ "urban", # assigning value to most common category
    TRUE ~ rural_urban  # Keep other values unchanged
  ))
table(df_hh$rural_urban)


table(df_hh$SHL06_SS_UND_PRESSURE) # EXCLUDE --- BECAUSE ONLY 19 PEOPLE REPORTED PRESSURE
table(df_hh$SHL04) # EXCLUDE --- rent paid on time? ONLY ABOUT 20% SAMPLE ANSWER THIS QUESTION AND ONLY 11 RESPONDENT INDICATED THAT THEY PAID LATE


# TEMPORARY PROTECTION 
names(df_hh)[names(df_hh) == "PRT02_SS_TEMP_PROT"] <-  "temp_protection_application"
table(df_hh$temp_protection_application)
table(df_hh$ind_temp_prot) # REMOVE THE SAMPLE IN THE NO (only 27 respondents) CATEGORY IS TOO LOW


# LOCAL HOSTILITY
names(df_hh)[names(df_hh) == "SC3_SS_EXP_HOSTILE"] <-  "local_hostility"

table(df_hh$local_hostility)


# Recode "DoNotKnow" to "PreferNotAnswer" as NO to create dummy variation
df_hh <- df_hh %>%
  mutate(local_hostility = case_when(
    local_hostility == "DoNotKnow" ~ "missing", 
    local_hostility == "PreferNotAnswer" ~ "missing",
    TRUE ~ local_hostility  # Keep other values unchanged
  ))

table(df_hh$local_hostility)




# PRIORITY NEEDS
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_no_needs"] <- "priority_need_none"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_accommodation"] <- "priority_need_accommodation"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_employment_livelihoods"] <- "priority_need_employment"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_food"] <- "priority_need_food"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_healthcare_services"] <- "priority_need_healthcare"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_language_courses"] <- "priority_need_language_courses"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_child_care_support"] <- "priority_need_childcare"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_medicines"] <- "priority_need_medicines"


# INCOME SOURCES 
names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_no_income"] <- "income_source_none"
names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_social_protection_host_govt"] <- "income_source_soc_protection_host"
names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_social_protection_ukr_govt"] <- "income_source_soc_protection_ukr"
names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_employment_host_country"] <- "income_source_employement_host"


# ACCOMMOTION 
names(df_hh)[names(df_hh) == "SHL05_SS_DUR_STAY"] <- "accommodation_duration"
table(df_hh$accommodation_duration)


df_hh <- df_hh %>%
  mutate(accommodation_duration = case_when(
    accommodation_duration  == "3_6_months" ~ "less_than_6_months", 
    accommodation_duration == "for_2_3_months" ~ "less_than_6_months",
    accommodation_duration == "for_the_coming_week" ~ "less_than_6_months",
    accommodation_duration == "for_up_to_1_month" ~ "less_than_6_months",
    accommodation_duration == "prefer_not_to_answer" ~ "less_than_6_months", # assign it as median - to the most common category 
    TRUE ~ accommodation_duration  # Keep other values unchanged
  ))
table(df_hh$accommodation_duration)


names(df_hh)[names(df_hh) == "DR7_SS_HH"] <- "household_head"
table(df_hh$household_head)


df_hh <- df_hh %>%
  mutate(household_head = case_when(
    household_head == "other" ~ "single", 
    household_head == "single-headed_household" ~ "single", 
    household_head == "yes,_head_or_cohead_of_household" ~ "cohead", 
    TRUE ~ household_head # Keep other values unchanged
  ))


table(df_hh$household_head)


################################################################################
# INDIVIDUAL LEVEL INDICATORS AGGREGATED TO HOUSEHOLD LEVEL
################################################################################


table(df_ind$E1_SS_ATT_EDU)
df_ind <- df_ind %>%
  mutate(education_attendance = case_when(
    is.na(E1_SS_ATT_EDU) ~ "other",  # If E1_SS_ATT_EDU is missing (NA), assign "other"
    E1_SS_ATT_EDU == "PreferNotAnswer" ~ "other",
    TRUE ~ as.character(E1_SS_ATT_EDU)  # Keep other values unchanged
  ))

table(df_ind$education_attendance)


################################################################################

df_ind <- df_ind %>%
  mutate(tag_child_not_attending_school = case_when(
    E1_SS_ATT_EDU == "no" ~ 1, 
    TRUE ~ 0
  ))

table(df_ind$tag_child_not_attending_school)

df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_number_children_not_attending_school = sum(tag_child_not_attending_school))


view(df_ind)


################################################################################
# Single - female household head
################################################################################

# df_ind_full$disability <- as.numeric(as.character(df_ind_full$disability))
# df_ind <- df_ind %>%
# rename("parent_index" = "_parent_index")

df_ind <- df_ind %>%
  mutate(tag_household_head = case_when(
    DR.13_SS_REL == "Head" ~ 1, 
    TRUE ~ 0
  ))

df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_household_heads = sum(tag_household_head))

df_ind <- df_ind %>%
  mutate(tag_household_head_female = case_when(
    DR.13_SS_REL == "Head" & female == 1 ~ 1,
    TRUE ~ 0  # Assign 0 for other cases
  ))


df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_female_household_heads = sum(tag_household_head_female))


 
 ###############################################################################
 
 # at least one person with work contract in a household
 
 df_ind <- df_ind %>%
   mutate(adult_employment_contract = case_when(
     SE11_SS_CONTRACT == "written_contract" ~ 1, 
     TRUE ~ 0
   ))
 
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_adults_employment_contract = sum(adult_employment_contract))

 
 ###############################################################################
 
 df_ind <- df_ind %>%
   mutate(tag_unemployed = case_when(
     SE8_SS_ACTIVITY == "status_unempl" ~ 1, 
     TRUE ~ 0
   ))

 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_unemployed = sum(tag_unemployed))
 
 
 ###############################################################################
 
 df_ind <- df_ind %>%
   mutate(tag_employed = case_when(
     SE2_SS_WORK == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_employed = sum(tag_employed))
 
 ###############################################################################
 
 df_ind <- df_ind %>%
   mutate(tag_psychological_issues = case_when(
     H11_SS_PSY == "yes" ~ 1, 
     TRUE ~ 0
   ))

 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_psychological_issue = sum(tag_psychological_issues))
 
 ###############################################################################
 
 df_ind <- df_ind %>%
   mutate(tag_health_issue = case_when(
     H1_SS_HLTH_PBLM == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_health_issues = sum(tag_health_issue))
 
 ###############################################################################
 
 df_ind <- df_ind %>%
   mutate(tag_chronic_illness = case_when(
     H2_SS_HLTH_CHRONIC_ILL == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_chronic_illness = sum(tag_chronic_illness))
 
 
 ###############################################################################
 
 
 names(df_ind)[names(df_ind) == "DR.15_NUM_INHC"] <- "arrival_number_months"
 
 # Remove rows where 'DR.15_NUM_INHC' is equal to 999
 df_ind$arrival_number_months <- ifelse(df_ind$arrival_number_months == 999, NA, df_ind$arrival_number_months)
 
 
 write.xlsx(df_ind, "final_individual_check.xlsx")
 
 
 ###############################################################################
 
 # Clean variable DR.13_SS_REL because we cannot have household head below 18, replace with other because we don't know the relationship  
 df_ind <- df_ind %>%
   mutate(DR.13_SS_REL = case_when(
     DR.13_SS_REL == "Head" & DR.11_NUM_AGE < 18 ~ "Other",
     TRUE ~ DR.13_SS_REL  # Keep the original value for other cases
   ))
 
 # Assuming df_ind is your data frame
 df_ind <- df_ind %>%
   mutate(education_level_number = case_when(
     SE1_SS_EDU_LVL == "grand_phd" ~ 8,
     SE1_SS_EDU_LVL == "phd" ~ 7,
     SE1_SS_EDU_LVL == "master" ~ 6,
     SE1_SS_EDU_LVL == "bachelor" ~ 5,
     SE1_SS_EDU_LVL == "tech" ~ 4,
     SE1_SS_EDU_LVL == "sec_edu" ~ 3,
     SE1_SS_EDU_LVL == "pri_edu" ~ 2,
     SE1_SS_EDU_LVL == "no_edu" ~ 1,
     SE1_SS_EDU_LVL == "PreferNotAnswer" ~ 6, # assign most common / median category
     TRUE ~ NA_integer_  # Assign NA for other cases
   ))
 
 
 # Assuming df_ind is your data frame
 result_df <- df_ind %>%
   select(parent_index, DR.13_SS_REL, DR.11_NUM_AGE, DR.12_SS_GEN, SE1_SS_EDU_LVL, education_level_number) %>%
   filter(DR.13_SS_REL == "Head") %>%
   arrange(parent_index, desc(education_level_number)) %>%
   group_by(parent_index) %>%
   slice(1) %>%
   ungroup()
 
 view(result_df)
 
 names(result_df)[names(result_df) == "DR.11_NUM_AGE"] <- "household_head_age"
 names(result_df)[names(result_df) == "DR.12_SS_GEN"] <- "household_head_gender"
 names(result_df)[names(result_df) == "SE1_SS_EDU_LVL"] <- "household_head_edu_level"
 names(result_df)[names(result_df) == "education_level_number"] <- "household_head_edu_level_number"
 
 
 df_hh$household_head_edu_level
 
 result_df <- result_df %>%
   mutate(household_head_edu_level = case_when(
     household_head_edu_level %in% c("master", "phd", "grand_phd", "PreferNotAnswer") ~ "Master and above",
     household_head_edu_level %in% c("no_edu", "pri_edu", "sec_edu") ~ "Lower education",
     TRUE ~ as.character(household_head_edu_level)
   ))
 
 table(df_hh$household_head_edu_level)
 
 
 # I should have 819 households 
 
 #write.xlsx(result_df, "final_household_head_education.xlsx")
 
 # Assuming result_d is your data frame
 result_df <- subset(result_df, select = -DR.13_SS_REL)
 
 df_hh <- left_join(df_hh, result_df, by = c("index" = "parent_index"))

 
 view(df_hh)
 
################################################################################
 
  
#### SUMMARISING THIS DATA ON AN INDIVIDUAL LEVEL 

 df_selected <- df_ind %>%
   select(
     parent_index,
     sum_number_children_not_attending_school,
     sum_household_heads,
     sum_adults_employment_contract,
     sum_unemployed,
     sum_employed,
     arrival_number_months,
     sum_chronic_illness,
     sum_health_issues,
     sum_psychological_issue,
     sum_female_household_heads
   ) 
 
 view(df_selected)
 
 # Use aggregate to calculate means for each variable grouped by 'parent_index'
 df_hh_ind <- aggregate(. ~ parent_index, data = df_selected, FUN = mean, na.rm = TRUE, na.action = na.pass)
 
 
 # Assuming df_hh and df_hh_ind are your data frames
 df_hh <- left_join(df_hh, df_hh_ind, by = c("index" = "parent_index"))
 
 df_hh <- df_hh %>%
   mutate(arrival_number_months = ifelse(is.na(arrival_number_months),
                                         median(arrival_number_months, na.rm = TRUE),
                                         arrival_number_months))
 
 
 # select respondent age, gender and education level 
 df_ind_filtered <- df_ind[df_ind$iteration_hh == 1, ]
 df_selected_variables <- df_ind_filtered[, c("parent_index", "DR.11_NUM_AGE", "DR.12_SS_GEN", "SE1_SS_EDU_LVL")]
 
 names(df_selected_variables)[names(df_selected_variables) == "DR.11_NUM_AGE"] <- "respondent_age" 
 names(df_selected_variables)[names(df_selected_variables) == "DR.12_SS_GEN"] <- "respondent_gender" 
 names(df_selected_variables)[names(df_selected_variables) == "SE1_SS_EDU_LVL"] <- "respondent_edu_level" 
 
 df_selected_variables <- df_selected_variables %>%
   mutate(respondent_edu_level = case_when(
     respondent_edu_level %in% c("master", "phd", "grand_phd", "PreferNotAnswer") ~ "Master and above",
     respondent_edu_level %in% c("no_edu", "pri_edu", "sec_edu") ~ "Lower education",
     TRUE ~ as.character(respondent_edu_level)
   ))
 
 
 table(df_selected_variables$respondent_edu_level)
 
 
 # Assuming df_hh and df_hh_ind are your data frames
 df_hh <- left_join(df_hh, df_selected_variables, by = c("index" = "parent_index"))
 
 
 ###############################################################################
 ### GENERATE DUMMIES 
 ###############################################################################
 
 #sum_number_children_not_attending_school - DUMMY 
 #sum_adults_employment_contract - DUMMY
 #sum_employed - DUMMY 
 #sum_chronic_illness - DUMMY
 #sum_health_issues - DUMMY 
 #sum_psychological_issue - DUMMY
 
 # dummy child not attending school
 df_hh <- df_hh %>%
   mutate(child_not_attending_school = case_when(
     df_hh$sum_number_children_not_attending_school > 0 ~ "yes", 
     df_hh$sum_number_children_not_attending_school == 0 ~ "no", 
     TRUE ~ "missing"
   ))
 
 # dummy employment contract
 df_hh <- df_hh %>%
   mutate(dummy_adult_employment_contract = case_when(
     df_hh$sum_adults_employment_contract > 0 ~ 1, 
     TRUE ~ 0
   )) 
 
 # dummy employment 
 df_hh <- df_hh %>%
   mutate(dummy_adult_employed = case_when(
     df_hh$sum_employed > 0 ~ 1, 
     TRUE ~ 0
   )) 
 
 # dummy chronic illness
 df_hh <- df_hh %>%
   mutate(dummy_chronic_illness = case_when(
     df_hh$sum_chronic_illness > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 # dummy health issues
 df_hh <- df_hh %>%
   mutate(dummy_health_issues = case_when(
     df_hh$sum_health_issues > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 # dummy pshychological issues
 df_hh <- df_hh %>%
   mutate(dummy_psychological_issue = case_when(
     df_hh$sum_psychological_issue > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 
 
 # generate single female tag 
 df_hh <- df_hh %>%
   mutate(dummy_single_female_head = case_when(
     df_hh$hh_size > 1 & df_hh$sum_female_household_heads >=1 ~ 1, 
     TRUE ~ 0
   ))
 
 
 
 
 ###############################################################################
 
 df_hh <- df_hh %>%
   mutate(household_head_edu_level = case_when(
     is.na(household_head_edu_level) ~ respondent_edu_level,
     TRUE ~ household_head_edu_level
   ))


 df_hh <- df_hh %>%
   mutate(household_head_gender = case_when(
     is.na(household_head_gender) ~ respondent_gender,
     household_head_gender == "other" ~ "female" , 
     TRUE ~ household_head_gender
   ))

 
 table(df_hh$household_head_gender)
 
 
 df_hh <- df_hh %>%
   mutate(household_head_age = case_when(
     is.na(household_head_age) ~ respondent_age,
     TRUE ~ household_head_age
   ))
 
################################################################################
################################################################################

 # VERY INTERESTING - AVERAGE EXPENDITURE BASED ON TWO CATEGORIES OF SOCIAL PROTECTION
 #df_hh %>%
#   group_by(outcome16_2_social_protection) %>%
#   summarize(avg_total_expenditure = mean(HHExpenditure, na.rm = TRUE))
 
 
 ################################################################################

 
# Replace missing values with 0 in all the RMS INDICATORS SINCE IT'S BETTER FOR REGRESSION TO NOT HAVE MISSING VALUES 
#df_hh <- df_hh %>%
#  mutate(
#    impact3_3_safety_walking = ifelse(is.na(impact3_3_safety_walking), 0, impact3_3_safety_walking),
#    outcome4_1_GBV = ifelse(is.na(outcome4_1_GBV), 0, outcome4_1_GBV),
#    outcome13_1_bank_account = ifelse(is.na(outcome13_1_bank_account), 0, outcome13_1_bank_account),
#    outcome13_2_income = ifelse(is.na(outcome13_2_income), 0, outcome13_2_income),
#    outcome16_2_social_protection = ifelse(is.na(outcome16_2_social_protection), 0, outcome16_2_social_protection)
#  )

 
 # Replace values in all the RMS INDICATORS
 df_hh <- df_hh %>%
   mutate(
     impact3_3_safety_walking = case_when(
       impact3_3_safety_walking == 1 ~ "yes",
       impact3_3_safety_walking == 0 ~ "no",
       is.na(impact3_3_safety_walking) ~ "missing",
       TRUE ~ as.character(impact3_3_safety_walking)
     ),
     outcome4_1_GBV = case_when(
       outcome4_1_GBV == 1 ~ "yes",
       outcome4_1_GBV == 0 ~ "no",
       is.na(outcome4_1_GBV) ~ "missing",
       TRUE ~ as.character(outcome4_1_GBV)
     ),
     outcome13_1_bank_account = case_when(
       outcome13_1_bank_account == 1 ~ "yes",
       outcome13_1_bank_account == 0 ~ "no",
       is.na(outcome13_1_bank_account) ~ "missing",
       TRUE ~ as.character(outcome13_1_bank_account)
     ),
     outcome13_2_income = case_when(
       outcome13_2_income == 1 ~ "yes",
       outcome13_2_income == 0 ~ "no",
       is.na(outcome13_2_income) ~ "missing",
       TRUE ~ as.character(outcome13_2_income)
     ),
     outcome16_2_social_protection = case_when(
       outcome16_2_social_protection == 1 ~ "yes",
       outcome16_2_social_protection == 0 ~ "no",
       is.na(outcome16_2_social_protection) ~ "missing",
       TRUE ~ as.character(outcome16_2_social_protection)
     )
   )
 

# FINAL SAMPLE REMOVING MISSING VALUES FROM DEPENDENT VARIABLE - 801 (for logistics regression) - removed 18 where Vulnerability score is missing
df_hh <- subset(df_hh, vulnerability_log_2 != 2)
table(df_hh$vulnerability_log_2)


table(df_hh$dummy_older_persons)
table(df_hh$house_heating)
table(df_hh$outcome16_2_social_protection)

 


write.xlsx(df_hh, "final_data_for_regression.xlsx")


# Create a summary table
summary_table <- tapply(df_hh$HHExpenditure, df_hh$Max_coping_behaviourEN, FUN = mean)

# Print the summary table
print(summary_table)


# Generate a bar chart
barplot(summary_table, main = "Average HHExpenditure by Max_coping_behaviourEN",
        xlab = "Max_coping_behaviourEN", ylab = "Average HHExpenditure",
        col = "skyblue", border = "black")



################################################################################
###  RUN LOGISTICS MODEL - FULL
################################################################################

# Convert variables to factors and set "yes" as the reference category
df_hh$outcome13_1_bank_account <- relevel(as.factor(df_hh$outcome13_1_bank_account), ref = "yes")
df_hh$impact3_3_safety_walking <- relevel(as.factor(df_hh$impact3_3_safety_walking), ref = "yes")
df_hh$outcome4_1_GBV <- relevel(as.factor(df_hh$outcome4_1_GBV), ref = "yes")
df_hh$outcome13_2_income <- relevel(as.factor(df_hh$outcome13_2_income), ref = "yes")
df_hh$outcome16_2_social_protection <- relevel(as.factor(df_hh$outcome16_2_social_protection), ref = "yes")

table(df_hh$accommodation_arrangement)


df_hh$household_head_edu_level <- relevel(as.factor(df_hh$household_head_edu_level), ref = "tech")
df_hh$accommodation_type <- relevel(as.factor(df_hh$accommodation_type), ref = "collective_site")
df_hh$accommodation_arrangement <- relevel(as.factor(df_hh$accommodation_arrangement), ref = "no_payment_free")


# Fit a logistic regression model - FULL MODEL 
model1 <- glm(vulnerability_log_2 ~ hh_size + 
                                    household_head_age + 
                                    household_head_edu_level + 
                                    household_head_gender + 
                                    total_income_sum +
                                    arrival_number_months + 
                                    income_source_none + 
                                    income_source_soc_protection_host + 
                                    income_source_soc_protection_ukr + 
                                    income_source_employement_host + 
                                    dummy_single_female_head + 
                                    dummy_adult_employed +
                                    dummy_adult_employment_contract + 
                                    dummy_health_issues + 
                                    dummy_chronic_illness + 
                                    dummy_psychological_issue + 
                                    dummy_pregnant_breastfeeding + 
                                    dummy_older_persons +
                                    disability_dummy + 
                                    child_dummy  + 
                                    rural_urban + 
                                    accommodation_type + 
                                    accommodation_arrangement + 
                                    accommodation_duration + 
                                    living_conditions_issues +
                                    outcome13_1_bank_account +  
                                    impact3_3_safety_walking + 
                                    outcome4_1_GBV + 
                                    outcome13_2_income + 
                                    outcome16_2_social_protection + 
                                    local_hostility  + 
                                    priority_need_none + 
                                    priority_need_food + 
                                    priority_need_accommodation + 
                                    priority_need_employment + 
                                    priority_need_healthcare +
                                    priority_need_language_courses +
                                    priority_need_childcare + 
                                    priority_need_medicines +
                                    rCSI, data = df_hh, family = "binomial")



# Summarize the model
summary(model1)

# Extract design matrix from the model
X <- model.matrix(model1)

# Summarize the model
model_summary1 <- summary(model1)

# Extract the coefficients table from the model summary
coefficients_table <- as.data.frame(model_summary1$coefficients)

# Add a column for variable names
coefficients_table$Variable <- rownames(coefficients_table)

# Define the path and filename for the Excel file
output_excel_file <- "logistic_regression_summary_full.xlsx"

# Export the coefficients table to an Excel file
writexl::write_xlsx(coefficients_table, path = output_excel_file)



# ------------------------------------------------------------------------------
# REDUCED MODEL: (ONLY SIGNIFICANT VARIABLES) -  
# ------------------------------------------------------------------------------

# Fit a logistic regression model - REDUCED MODEL
model2 <- glm(vulnerability_log_2 ~ hh_size +
                                    household_head_age + 
                                    household_head_edu_level +
                                    arrival_number_months + 
                                    total_income_sum + 
                                    accommodation_type + 
                                    accommodation_arrangement +
                                    dummy_adult_employment_contract +
                                    priority_need_food + 
                                    priority_need_accommodation +
                                    priority_need_healthcare, data = df_hh, family = "binomial")


# Summarize the model
summary(model2)


# Summarize the model
model_summary1 <- summary(model2)

# Extract the coefficients table from the model summary
coefficients_table <- as.data.frame(model_summary1$coefficients)

# Add a column for variable names
coefficients_table$Variable <- rownames(coefficients_table)

# Define the path and filename for the Excel file
output_excel_file <- "logistic_regression_summary_reduced.xlsx"

# Export the coefficients table to an Excel file
writexl::write_xlsx(coefficients_table, path = output_excel_file)


# Extract design matrix from the model
#X <- model.matrix(model2)

# Calculate VIF
#vif_values <- car::vif(model2)
#print(vif_values)



################################################################################
###  ODDS RATIOS 
################################################################################


# Extract the coefficient estimates from the model
coef_estimates <- coef(model2)

# Extract the standard errors for the coefficients
std_errors <- summary(model2)$coef[, "Std. Error"]

# Calculate the odds ratios and their confidence intervals
odds_ratios <- exp(coef_estimates)
lower_ci <- exp(coef_estimates - 1.96 * std_errors)
upper_ci <- exp(coef_estimates + 1.96 * std_errors)

# Create a data frame to display the results
odds_ratio_table <- data.frame(
  Variable = names(coef_estimates),
  Odds_Ratio = odds_ratios,
  Lower_CI = lower_ci,
  Upper_CI = upper_ci
)

# Print the odds ratio table
print(odds_ratio_table)

write_xlsx(odds_ratio_table, path = "logistics_regression_odds_ratio_table_reduced.xlsx")



# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
# MULTIPLE LINEAS REGRESSION:  EXPENDITURE OUTCOME VARIABLE
# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------


# INCOME SOURCES 

reg_model1 <- lm(HHExpenditure_median ~ 
                   hh_size +
                   household_head_age + 
                   household_head_edu_level + 
                   household_head_gender + 
                   arrival_number_months + 
                   total_income_sum + 
                   income_source_none + 
                   income_source_soc_protection_host + 
                   income_source_soc_protection_ukr + 
                   income_source_employement_host + 
                   dummy_single_female_head + 
                   dummy_adult_employed +
                   dummy_adult_employment_contract + 
                   dummy_health_issues + 
                   dummy_chronic_illness + 
                   dummy_psychological_issue + 
                   dummy_pregnant_breastfeeding + 
                   dummy_older_persons +
                   disability_dummy + 
                   child_dummy  + 
                   accommodation_type + 
                   accommodation_arrangement + 
                   accommodation_duration + 
                   living_conditions_issues + 
                   outcome13_1_bank_account +  
                   impact3_3_safety_walking + 
                   outcome4_1_GBV + 
                   outcome13_2_income + 
                   outcome16_2_social_protection + 
                   local_hostility  + 
                   priority_need_none + 
                   priority_need_food + 
                   priority_need_accommodation + 
                   priority_need_employment + 
                   priority_need_healthcare +
                   priority_need_language_courses +
                   priority_need_childcare +
                   priority_need_medicines +
                   FCS + 
                   stress_coping_EN + 
                   crisis_coping_EN +
                   emergency_coping_EN +
                   total_income_sum + 
                   rCSI, data = df_hh)


# Summarize the model
summary(reg_model1)
model_summary <- summary(reg_model1)


# OUTPUT to EXCEL FILE 

# Define the path and file name for the Excel file
output_excel_file <- "linear_regression_summary_1_full.xlsx"

# Extract the coefficients table from the summary
coefficients_table <- model_summary$coefficients

# Create a data frame with variable names and significance levels
coefficients_df <- data.frame(
  Variable = rownames(coefficients_table),
  Coefficient = coefficients_table[, 1],
  Std.Error = coefficients_table[, 2],
  t.value = coefficients_table[, 3],
  Pr.Value = coefficients_table[, 4]
)

# Export the coefficients data frame to an Excel file
writexl::write_xlsx(coefficients_df, path = output_excel_file)



### ----------------------------------------------------------------------------
###          REDUCED MODEL - ONLY SIGNIFICANT VARIABLES
### ----------------------------------------------------------------------------


reg_model2 <- lm(HHExpenditure_median ~ 
                   hh_size +
                   household_head_age + 
                   household_head_edu_level + 
                   household_head_gender + 
                   arrival_number_months + 
                   total_income_sum + 
                   income_source_employement_host + 
                   disability_dummy + 
                   accommodation_type + 
                   accommodation_arrangement + 
                   outcome4_1_GBV + 
                   local_hostility  + 
                   priority_need_food + 
                   priority_need_employment + 
                   stress_coping_EN + 
                   crisis_coping_EN + 
                   rCSI, data = df_hh)


# Summarize the model
summary(reg_model2)
model_summary <- summary(reg_model2)


# Define the path and file name for the Excel file
output_excel_file <- "linear_regression_summary_2_reduced.xlsx"

# Extract the coefficients table from the summary
coefficients_table <- model_summary$coefficients

# Create a data frame with variable names and significance levels
coefficients_df <- data.frame(
  Variable = rownames(coefficients_table),
  Coefficient = coefficients_table[, 1],
  Std.Error = coefficients_table[, 2],
  t.value = coefficients_table[, 3],
  Pr.Value = coefficients_table[, 4]
)

# Export the coefficients data frame to an Excel file
writexl::write_xlsx(coefficients_df, path = output_excel_file)


# ------------------------------------------------------------------------------
# EXPENDITURE OVERVIEW & BAR CHART 
# ------------------------------------------------------------------------------

# df_hh <- subset(df_hh, HHExpenditure != 0)
library(unhcrthemes)

# df_hh <- subset(df_hh, HHExpenditure != 0)
average_HHExpenditure <- mean(df_hh$HHExpenditure, na.rm = TRUE)
print(average_HHExpenditure)

library(ggplot2)

variables_to_average <- c("HHExp_FoodItems_1M", 
                          "HHExpNFRent_1M", 
                          "HHExpNFHyg_1M", 
                          "HHExpNFUtil_1M", 
                          "HHExpNFPhone_1M", 
                          "HHExpNFEdu_1M", 
                          "HHExpNFMedServ_1M", 
                          "HHExpNFDebt_1M",
                          "HHExpNFOther_1M",
                          "HHExpenditure")

# Calculate the averages
averages <- sapply(df_hh[variables_to_average], mean, na.rm = TRUE)

# Create a data frame for plotting
averages_data <- data.frame(Variable = names(averages), Average = averages)
# Sort the data frame in descending order of averages
averages_data <- averages_data[order(averages_data$Average, decreasing = TRUE), ]

# Clean and simplify the labels
variable_labels <- c(
  "HHExp_FoodItems_1M" = "Food",
  "HHExpNFRent_1M" = "Rent",
  "HHExpNFHyg_1M" = "Hygiene",
  "HHExpNFUtil_1M" = "Utilities",
  "HHExpNFPhone_1M" = "Phone",
  "HHExpNFEdu_1M" = "Education",
  "HHExpNFMedServ_1M" = "Medical",
  "HHExpNFDebt_1M" = "Debt",
  "HHExpNFOther_1M" = "Other",
  "HHExpenditure" = "Total"
)

# Create a simple bar chart
p <- ggplot(averages_data, aes(x = reorder(Variable, -Average), y = Average)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  # geom_text(aes(label = n), hjust = 0, nudge_x = 1) +
  geom_text(aes(label = round(Average, 2), vjust = -0.3, nudge_x = 2), size = 4) +  # Adjust nudge_y to lift labels higher
  labs(
    title = "Average Expenditure by Category in Slovakia",
    subtitle = "Household Level",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = variable_labels) +  # Use variable_labels for X-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none")  + # Remove the legend
  xlab(NULL) +  # Remove x-axis label
  ylab(NULL)    # Remove y-axis label

# Save the plot to a file with adjusted size for A4 page
ggsave("your_plot_Irma_UNHCR_3.png", plot = p, width = 8.27, height = 5, units = "in", dpi = 300)


# ------------------------------------------------------------------------------
# % SHARE EXPENDITURE OVERVIEW & BAR CHART 
# ------------------------------------------------------------------------------

# Calculate the averages for share variables
share_variables <- c(
  "share_food_expenditure",
  "share_accomm_expenditure",
  "share_health_expenditure",
  "share_hygiene_expenditure",
  "share_communication_expenditure",
  "share_hh_bills_expenditure",
  "share_education_expenditure",
  "share_debt_expenditure",
  "share_other_expenditure"
)

averages_share <- sapply(df_hh[share_variables], mean, na.rm = TRUE)

# Create a data frame for plotting
averages_share_data <- data.frame(Variable = names(averages_share), Average = averages_share)

# Clean and simplify the labels
variable_labels <- c(
  "share_food_expenditure" = "Food",
  "share_accomm_expenditure" = "Accommodation",
  "share_health_expenditure" = "Health",
  "share_hygiene_expenditure" = "Hygiene",
  "share_communication_expenditure" = "Phone",
  "share_hh_bills_expenditure" = "Household Bills",
  "share_education_expenditure" = "Education",
  "share_debt_expenditure" = "Debt",
  "share_other_expenditure" = "Other"
)

# Sort the data frame in descending order of averages
averages_share_data <- averages_share_data[order(averages_share_data$Average, decreasing = TRUE), ]

# Create a simple bar chart
p_share <- ggplot(averages_share_data, aes(x = reorder(Variable, -Average), y = Average)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  geom_text(aes(label = paste0(round(Average * 100, 1), "%")), vjust = -0.3, nudge_x = 0, size = 4) +  # Adjust label position
  labs(
    title = "Average Share of Expenditure by Category in Slovakia",
    subtitle = "Household Level",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = variable_labels) +  # Use variable_labels for X-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none")  + # Remove the legend
  xlab(NULL) +  # Remove x-axis label
  ylab(NULL)    # Remove y-axis label

# Save the plot to a file with adjusted size for A4 page
ggsave("your_share_plot_Irma_UNHCR.png", plot = p_share, width = 8.27, height = 5, units = "in", dpi = 300)


# ------------------------------------------------------------------------------
# PER CAPITA HOUSEHOLD EXPENDITURE
# ------------------------------------------------------------------------------

# Define the categories and corresponding labels
categories <- c(
  "HHExp_FoodItems_1M" = "Food",
  "HHExpNFRent_1M" = "Rent",
  "HHExpNFHyg_1M" = "Hygiene",
  "HHExpNFUtil_1M" = "Utilities",
  "HHExpNFPhone_1M" = "Phone",
  "HHExpNFEdu_1M" = "Education",
  "HHExpNFMedServ_1M" = "Medical",
  "HHExpNFDebt_1M" = "Debt",
  "HHExpNFOther_1M" = "Other",
  "HHExpenditure" = "Total"
)

# Create a function to calculate average income per capita
calculate_average_income_per_capita <- function(category, df) {
  average_per_capita <- mean(df[[category]] / df$HHSize, na.rm = TRUE)
  return(average_per_capita)
}

# Create a data frame for average income per capita
per_capita_data <- data.frame(Category = names(categories))
per_capita_data$AverageIncomePerCapita <- sapply(names(categories), function(category) {
  calculate_average_income_per_capita(category, df_hh)
}, simplify = "vector")

# Remove rows with NA values
per_capita_data <- per_capita_data[!is.na(per_capita_data$AverageIncomePerCapita), ]

# Sort the data frame in descending order of average income per capita
per_capita_data <- per_capita_data[order(per_capita_data$AverageIncomePerCapita, decreasing = TRUE), ]

# Create a simple bar chart
p <- ggplot(per_capita_data, aes(x = reorder(Category, -AverageIncomePerCapita), y = AverageIncomePerCapita)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  geom_text(aes(label = round(AverageIncomePerCapita, 2), vjust = -0.3, nudge_x = 2), size = 4) +
  labs(
    title = "Average Expenditure per Capita by Category in Slovakia",
    subtitle = "Total Household Expenditure per Household Member",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = categories) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none") +
  xlab(NULL) +
  ylab(NULL)

# Save the plot to a file with adjusted size for A4 page
ggsave("average_income_per_capita_plot.png", plot = p, width = 8.27, height = 5, units = "in", dpi = 300)



